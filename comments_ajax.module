<?php

/**
 * Implement hook_menu
 */
function comments_ajax_menu() {
  $items['comment/list/all/%/%'] = array(
    'title' => 'Load comments',
    'page callback' => 'comments_ajax_show_all',
    'page arguments' => array(3,4),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  );
  $items['comments_ajax_comment_form_submit'] = array(
    'page callback' => 'comments_ajax_comment_form_submit',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  
  // Callback when click link
  $items['comment/post/%'] = array(
    'title' => 'Form comments',
    'page callback' => 'comments_ajax_post',
    'page arguments' => array(2),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  );
//  // Callback when form submit
//  $items['comments_ajax_comment_list_form_submit'] = array(
//    'title' => 'Send',
//    'page callback' => 'comments_ajax_comment_list_form_submit',
//    'access arguments' => array('access content'),
//    'type' => MENU_CALLBACK
//  );
  return $items;
}

function comments_ajax_show_all($nid, $cid){
  // Load newsfeed_comment
  $comments = views_embed_view('newsfeed_comment', 'block_2', array($nid, $cid));
  return drupal_json(array('comments' => $comments, 'nid' => $nid));
  exit;
}

/**
 * Form comment
 */
function comments_ajax_comment_form($form_state, $nid) {
  $form = array();
  $form['comment']=array(
    '#type' => 'textarea',
    '#title' => 'Comment',
    '#size' => 3,
    '#maxlength' => 200,
    '#required' => TRUE,
//    '#default_value' => 'Reply or add a comment',
  );
  $form['nid'] = array(
      '#type' => 'hidden',
      '#value' => $nid,
      );
  $form['submit'] = array(
		'#type' => 'submit',
		'#value' => t('post'),
		'#submit' => array(),
		'#ahah' => array(
			'path' => 'comments_ajax_comment_form_submit',
			'wrapper' => 'divComments-' . $nid,
			'method' => 'append',
			'effect' => 'fade',
			'progress' => array('type' => 'throbber','message' => t('Please wait...')),
		),
	);
  $form['comment']['#attributes'] = array('title' => 'Reply or add a comment');
  $form['submit']['#attributes'] = array('class' => 'comments_ajax_submit_button');
  return $form;
}



/**
 * Menu ahah callback
 */
function comments_ajax_comment_form_submit() {
  global $user;
  $profile = content_profile_load('basic', $user->uid, '', NULL);
  $user_image_path = $profile->field_user_picture[0]['filepath'];
  if (trim($user_image_path) == '') {
    $user_image_path = drupal_get_path('module', 'fb_style_dropdown').'/default.gif';
  }
  $user_image = theme('imagecache', 'newsfeeds_comment_avatar', $user_image_path);
  $avatar =  l($user_image, 'user/' . $user->uid, array('attributes' => array('target'=>"_blank"), 'html' => TRUE,));
  
  if (empty($_REQUEST['comment'])) {
    return drupal_json(array('status' => TRUE, 'data' => ''));
  }
  $comment['nid'] = $_REQUEST['nid'];
  $comment['uid'] = $user->uid;
  $comment['comment'] = $_REQUEST['comment'];
  $cid = comment_save($comment);
  $comment = _comment_load($cid);
  
	$output = theme('comments_ajax_theme', $user, $profile, $comment, $avatar);
	return drupal_json(array('status' => TRUE, 'data' => $output));
}


/**
 * Menu callback
 */
function comments_ajax_post($nid) {
  $form = drupal_get_form('comments_ajax_comment_form', $nid);
  $comments = views_embed_view('newsfeed_comment', 'block_2', array($nid));
  $form['new_row_wrapper'] = array(
		'#type' => 'markup',
		'#value' => $comments,
    '#weight' => -10,
	);
  return drupal_json(array('form' => $form, 'nid' => $nid));
}


//function comments_ajax_form_load($nid){
//  
//  
//  $form = drupal_get_form('');
//  return drupal_json(array('comments' => $form, 'nid' => $nid));
//  exit;
//}
//
///**
// * Form post comment:
// * - Form post comment
// * - List comments
// */
//function comments_ajax_comment_list_form($form_state, $nid) {
//  // List comments
//  $comments = views_embed_view('newsfeed_comment', 'block_2', array($nid));
//  $form['new_row_wrapper'] = array(
//		'#type' => 'markup',
//		'#value' => $comments,
//	);
//  
//  $form['comment']=array(
//    '#type' => 'textarea',
//    '#title' => 'Comment',
//    '#size' => 3,
//    '#maxlength' => 200,
//    '#required' => TRUE,
////    '#default_value' => 'Reply or add a comment',
//  );
//  $form['nid'] = array(
//      '#type' => 'hidden',
//      '#value' => $nid,
//      );
//  $form['submit'] = array(
//		'#type' => 'submit',
//		'#value' => t('post'),
//		'#submit' => array(),
//		'#ahah' => array(
//			'path' => 'comments_ajax_comment_list_form_submit',
//			'wrapper' => 'divComments-' . $nid,
//			'method' => 'append',
//			'effect' => 'fade',
//			'progress' => array('type' => 'throbber','message' => t('Please wait...')),
//		),
//	);
//  $form['comment']['#attributes'] = array('title' => 'Reply or add a comment');
//  $form['submit']['#attributes'] = array('class' => 'comments_ajax_submit_button');
//  return $form;
//}
//
///**
// * Menu ahah callback
// */
//function comments_ajax_comment_list_form_submit() {
//  
//}



/**
 * Implement hook_theme()
 */
function comments_ajax_theme() {
  return array(
    'comments_ajax_theme' => array(
      'template' => 'comments_ajax',
      'arguments' => array('user' => NULL, 'profile' => NULL, 'comment' => NULL, 'avatar' => NULL),
    ),
  );
}

/**
 * Implement hook_init().
 */
function comments_ajax_init() {
  drupal_add_js(drupal_get_path('module', 'comments_ajax') . '/comments_ajax.js');
}
