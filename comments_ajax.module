<?php

/**
 * Implement hook_menu
 */
function comments_ajax_menu() {
  $items['comment/list/all/%/%'] = array(
    'title' => 'Load comments',
    'page callback' => 'comments_ajax_show_all',
    'page arguments' => array(3,4),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  );
  $items['comment/post/%'] = array(
    'title' => 'Form comments',
    'page callback' => 'comments_ajax_post',
    'page arguments' => array(2),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  );
  return $items;
}

function comments_ajax_show_all($nid, $cid){
  $comments = views_embed_view('newsfeed_comment', 'block_2', array($nid, $cid));
  ctools_include('ajax');
  $commands = array();
  $commands[] = ctools_ajax_command_html("#div-comments-{$nid}", $comments);
  ctools_ajax_render($commands); 
}

/**
 * Form comment
 */
function comments_ajax_comment_form($form_state, $nid, $cid = 0, $comments = FALSE) {
  $form = array();
  if ($comments) {
    $comments = views_embed_view('newsfeed_comment', 'block_2', array($nid));
    $form['comments_wapper'] = array(
      '#type' => 'markup',
      '#value' => $comments,
      '#weight' => -10,
    );
    $form['$comments'] = array(
      '#type' => 'hidden',
      '#value' => TRUE,
    );
  }
  $form['comment']=array(
    '#type' => 'textarea',
    '#title' => 'Comment',
    '#size' => 3,
    '#maxlength' => 200,
    '#required' => TRUE,
  );
  $form['nid'] = array(
      '#type' => 'hidden',
      '#value' => $nid,
  );
  $form['submit'] = array(
		'#type' => 'submit',
		'#value' => t('post'),
		'#attributes' => array('class' => 'ctools-use-ajax', 'title' => 'Reply or add a comment'),
	);
  $form['#prefix'] = "<div class='form-comments'>";
  $form['#suffix'] = "</div>";
  return $form;
}

/**
 * Menu ahah callback
 */
function comments_ajax_comment_form_submit($form, $form_state) {
  global $user;
  $profile = content_profile_load('basic', $user->uid, '', NULL);
  $user_image_path = $profile->field_user_picture[0]['filepath'];
  if (trim($user_image_path) == '') {
    $user_image_path = drupal_get_path('module', 'fb_style_dropdown').'/default.gif';
  }
  $user_image = theme('imagecache', 'newsfeeds_comment_avatar', $user_image_path);
  $avatar =  l($user_image, 'user/' . $user->uid, array('attributes' => array('target'=>"_blank"), 'html' => TRUE,));
  
  $comment['nid'] = $form_state['clicked_button']['#post']['nid'];
  $comment['uid'] = $user->uid;
  $comment['comment'] = $form_state['clicked_button']['#post']['comment'];
  $cid = comment_save($comment);
  $comment = _comment_load($cid);
  
	$output = theme('comments_ajax_theme', $user, $profile, $comment, $avatar);
  
	ctools_include('form');
  ctools_include('ajax');
  
  // Have comments
  if (isset($form_state['values']['comments'])) {
    $commands [] = ctools_ajax_command_append ('#ahah-example-new-row-wrapper', $output);
    ctools_ajax_render($commands);
  }
  $commands [] = ctools_ajax_command_append ("#div-comments-{$form_state['clicked_button']['#post']['nid']}", $output);
  ctools_ajax_render($commands);
}


/**
 * Menu callback
 */
function comments_ajax_post($nid) {
  $form = drupal_get_form('comments_ajax_comment_form', $nid, FALSE, TRUE);
  ctools_include('ajax');
  $commands = array();
  $commands[] = ctools_ajax_command_html("#div-comments-post-{$nid}", $form);
  ctools_ajax_render($commands); 
  

}

/**
 * Implement hook_theme()
 */
function comments_ajax_theme() {
  return array(
    'comments_ajax_theme' => array(
      'template' => 'comments_ajax',
      'arguments' => array('user' => NULL, 'profile' => NULL, 'comment' => NULL, 'avatar' => NULL),
    ),
  );
}


